name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      aws_region:
        description: "Primary AWS region for STS/action defaults"
        required: false
        type: string
        default: "eu-west-2"
      ng_regions:
        description: "Comma-separated regions scanned by Nimbus Guard"
        required: false
        type: string
        default: "eu-west-2,eu-west-1"
      ng_fail_on:
        description: "Fail threshold (INFO|LOW|MEDIUM|HIGH|CRITICAL)"
        required: false
        type: string
        default: "HIGH"

permissions:
  id-token: write
  contents: read

jobs:
  oidc-smoke-test:
    name: Scan Results
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.NIMBUS_GUARD_ROLE_ARN }}
          role-session-name: nimbus-guard-ci
          aws-region: ${{ inputs.aws_region || 'eu-west-2' }}

      - name: Enable BuildKit
        run: echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV

      - name: Derive short SHA
        id: vars
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build \
            -f docker/Dockerfile \
            -t nimbus-guard:latest \
            -t nimbus-guard:$SHORT_SHA \
            .

      - name: Prepare out dir on runner
        run: mkdir -p out && chmod 777 out

      - name: Run Nimbus Guard (Docker)
        # Will exit non-zero if findings >= NG_FAIL_ON (by design)
        env:
          AWS_ACCESS_KEY_ID: ${{ env.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ env.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ env.AWS_SESSION_TOKEN }}
        run: |
          docker run --rm \
            -u 1001:1001 \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e AWS_SESSION_TOKEN \
            -e AWS_REGION="${{ inputs.aws_region || 'eu-west-2' }}" \
            -e AWS_DEFAULT_REGION="${{ inputs.aws_region || 'eu-west-2' }}" \
            -e NG_REGIONS="${{ inputs.ng_regions || 'eu-west-2,eu-west-1' }}" \
            -e NG_FAIL_ON="${{ inputs.ng_fail_on || 'HIGH' }}" \
            -e NG_OUT="/app/out" \
            -v "${{ github.workspace }}/out:/app/out" \
            nimbus-guard:latest

      - name: List generated reports
        if: always()
        run: ls -l out || true

      - name: Upload reports (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nimbus-guard-reports-${{ env.SHORT_SHA || github.run_id }}
          path: |
            out/nimbus-guard-report.html
            out/nimbus-guard-report.md
            out/nimbus-guard-findings.json
          if-no-files-found: warn
          retention-days: 14

      - name: Attach summary
        if: always()
        run: |
          echo "## Nimbus Guard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Regions: eu-west-2, eu-west-1" >> $GITHUB_STEP_SUMMARY
          echo "- Fail threshold: HIGH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts: nimbus-guard-reports-${{ env.SHORT_SHA || github.run_id }}" >> $GITHUB_STEP_SUMMARY